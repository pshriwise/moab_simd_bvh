

#define TEST_SPHERE "${CMAKE_CURRENT_BINARY_DIR}/test_files/sphere.h5m"
#define TEST_CUBE "${CMAKE_CURRENT_BINARY_DIR}/test_files/cube.h5m"

#include "assert.h"

#include "moab/Core.hpp"
#include "moab/CartVect.hpp"

#include "Primitive.h"
#include "Builder.h"
#include "Intersector.h"
#include "MBVH.h"

static const float PI = acos(-1.0);
static const float denom = 1.0 / ((float) RAND_MAX);
static const float denomPI = PI * denom;

inline void RNDVEC(Vec3fa& uvw, float &az)
{
  // denom normalizes rand values (see global defines)
  double theta = az * denom * rand(); // randomly samples from 0 to az. (Default az is 2PI)
  double u = 2 * denom * rand() - 1; // randomly samples from -1 to 1.
  uvw[0] = sqrt(1-u*u)*cos(theta);
  uvw[1] = sqrt(1-u*u)*sin(theta);
  uvw[2] = u;
}

moab::ErrorCode test_file(std::string filename) {
    moab::Interface* mbi = new moab::Core();
  
  moab::ErrorCode rval;
  
  rval = mbi->load_file(filename.c_str());
  MB_CHK_SET_ERR(rval, "Failed to load test file");

  moab::Range all_tris;

  rval = mbi->get_entities_by_type(0, moab::MBTRI, all_tris, true);
  MB_CHK_SET_ERR(rval, "Failed to get all triangles in the model");

  std::vector<TriangleRef> tris;

  moab::Range::iterator i;
  int counter = 0;
  for(i = all_tris.begin(); i != all_tris.end(); i++) {

    moab::EntityHandle tri = *i;

    TriangleRef t = TriangleRef(tri, mbi);
    
    tris.push_back(t);
    
  }


  TriangleBVH TBVH(create_leaf);

  BuildSettings settings;
  
  BuildStateTri bs = BuildStateTri(0, tris);

  NodeRef* root = TBVH.Build(settings, bs);
  
  TriIntersector TINT;

  Vec3fa org(0.0, 0.0, 0.0);

  float angle = 2*PI;
  int num_rand_rays = 1E4;
  for(unsigned int i = 0; i < num_rand_rays; i++) {    
    Vec3fa dir;
    
    RNDVEC(dir, angle);
  
    Ray r = Ray(org, dir, 0.0, inf);
    
    TINT.intersectRay(*root, r);
  
    assert(r.tfar < inf);
    
  }

 delete mbi;
 delete root;
 
}

int main(int argc, char** argv) {

  int num_fails = 0;
  num_fails += test_file(TEST_SPHERE);
  num_fails += test_file(TEST_CUBE);

return num_fails;

}
